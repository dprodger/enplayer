<!DOCTYPE html>
<html>
    <head>

        <style>
            @import url('sp://import/css/eve.css');
            @import url('sp://enplayer/css/main.css');
            @import url('sp://enplayer/css/github.css');
        </style>

        <script src="sp://enplayer/js/jquery.min.js"></script>
        <script src="sp://enplayer/js/rainbow-custom.min.js"></script>

<script>
jQuery.ajaxSettings.traditional = true;  

var sp;
var models;

$(document).ready(function() {
	/* Instantiate the global sp object; include models & views */
	sp = getSpotifyApi(1);
	models = sp.require('sp://import/scripts/api/models');
});

var enSongs = [];
var enToSpotIds = {};

var counts = 0; // spinlock

var pl;

function make_it() {
	playlistName = $("#_name").val();
	songIDs = $("#_ids").val();
	
	enSongs = new Array();
	$("#results-list").empty();
	
	if( ""===playlistName || ""===songIDs ) {
		alert( "You need to provide both a playlist name and IDs");
	} else {
		var lines = songIDs.split( "\n" );
		
		//TODO fix this up--it's pretty gross
		for( i = 0; i < lines.length; i++ ) {
			_line = lines[i];
			_song = _line.indexOf( "SO");
			_thesong = _line.substring( _song, _song + 18 );
//			console.log( "_line is " + _line);
//			console.log( "_thesong is " + _thesong );
			
			if( _thesong ) {
				enSongs.push( _thesong );
				++counts;
				var parentList = document.getElementById("results-list");
				var listitem = document.createElement("li");
				listitem.setAttribute('id', _thesong);
				listitem.innerHTML = "Song: " + _thesong;
				parentList.appendChild( listitem );
				lookupSpotifyID( _thesong );
			} else {
//				console.log( "skipping blank song");
			}
		}
	}
}

function create_it() {
	// actually make the playlist
	//TODO if playlist name is in use, see about overwriting vs making a new one
	playlistName = $("#_name").val();
	pl = new models.Playlist( playlistName );	

	console.log("*** in create_it");
	for( i = 0; i < enSongs.length; i++ ) {
		_song = enSongs[ i ];
		_spotifyTrack = enToSpotIds[ _song ];
		if( _spotifyTrack ) {
			console.log( "EN Song ID " + _song + " is " + _spotifyTrack );
			pl.add( _spotifyTrack );
		} else { 
			console.log( "EN Song ID " + _song + " has no valid tracks; skipping.");
		}
	}
}


function lookupSpotifyID( _song ) {
	var url = "http://developer.echonest.com/api/v4/song/profile?api_key=EIB5LKB6YDEG5TM2Q&callback=?";
	
	$.getJSON( url, 
		{
			"id": _song,
			"format": "jsonp",
			'bucket': ['tracks', 'id:spotify-WW'],
			"limit": true
		},
		function(data) {
			var response = data.response;
			var songs = response.songs;
			var tracks = songs[0].tracks;
			//TODO if there are multiple tracks, check them all to see which are valid in this region...
			
			var _trackID = findValidTrack( songs[0].id, tracks );
			var _trackID = _trackID.replace("spotify-WW", "spotify");
			enToSpotIds[ songs[0].id ] = _trackID;
			console.log( "EN Song ID " + songs[0].id + " is " + _trackID); 
			--counts;
		})
}

// just return first track
// eventually get all tracks, and walk until we get one that is valid for this region
var trackCount = [];

var validTracks = [];


function findValidTrack( songID, tracks ) {
	console.log("* in findValidTrack for " + songID + " and I have " + tracks.length + " tracks to check" );
	trackCount[ songID ] = 0;
	
	// set default so we know if none found
	var plItem = document.getElementById( songID );
	plItem.innerHTML = "Song: " + songID + "; no valid tracks found yet.";
	enToSpotIds[ songID ] = null;
	
	for( i = 0; i < tracks.length; i++ ) {
		trackCount[ songID ]++;
		console.log( "*** songID = " + songID + "; trackCount is " + trackCount[ songID ] );
		var _trackID = tracks[i].foreign_id.replace("spotify-WW", "spotify");
    	
		var t = models.Track.fromURI( _trackID, function(track) {
			console.log( "--- in inner function for songID = " + songID + "; trackCount is " + trackCount[ songID ] );

			trackCount[ songID ]--;
			console.log( "track " + track.uri + "; is playable? " + track.playable + "; album year is " + track.album.year );
			
			if( track.playable) {
				var _uri = track.uri;
				var _year = track.album.year;
				var _title = track.name;
				var _album = track.album.name;
				
				if( validTracks[songID] ) {
					if( validTracks[songID].year > track.album.year) {
						validTracks[songID] = { "id":_uri, "year":_year , "title":_title, "album":_album};
						console.log("track: " + track.uri + "is the new best track for song " + songID );
					}
				
				} else {
					validTracks[songID] = { "id":_uri, "year":_year , "title":_title, "album":_album};
					console.log("track: " + track.uri + "is the new best track for song " + songID );
				}
				var plItem = document.getElementById( songID );
				plItem.innerHTML = "EN: " + songID + " SP: " + validTracks[songID].id + " ; Title: " + validTracks[songID].title + " (" +validTracks[songID].year + ", " + validTracks[songID].album + ")";
				enToSpotIds[ songID ] = validTracks[songID].id;
			}
		} );
	}
	
	waitForTrackCompletion( songID );
	
	console.log("the validTrack for songID " + songID + " is " + validTracks[ songID ].id );
	return validTracks[ songID ].id;
}

function waitForTrackCompletion( songID ) {
	if( trackCount[ songID ] < 1 ) {
		return;
	}
	
	setTimeout( waitForTrackCompletion( songID ), 500 );
}
        </script>
    </head>
    <body>
        <div id="wrapper">
            <h1>Create Spotify Playlist from Echo Nest IDs</h1>
            <p class="description">Given a playlist name and a list of Echo Nest song IDs, create a playlist by that name, and populate it with as many of the Songs that have Tracks as possible</p>

			<h2>Playlist Definition<h2>
			Playlist name: <br />
			<input type="text" id="_name" placeholder="Enter a valid Spotify playlist name" size="50"/><br /><br />
			
			Echo Nest Song IDs:<br />
			<textarea id="_ids" placeholder="Enter EN Song IDs here; one per line" cols="100" rows="15"></textarea><br /><br />
			
			<input type="submit" id="_go" value="Make Playlist!" onclick="make_it();" />
			
			<h2>Resultant Playlist</h2>
			<div id="results">
				<ul id="results-list">
				</ul>
			</div>
			<input type="submit" id="_forreals" value="Create Playlist" onclick="create_it();" />
        </div><!-- /wrapper -->
    </body>
</html>
